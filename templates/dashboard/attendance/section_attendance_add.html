{% extends 'dashboard/dashboard.html' %}

{% block title %} Take Section Attendance {% endblock %}

{% load custom_filters %}

{% block content %}

<div class="container-fluid">
  <div class="row">
    <h4>Attendance for {{ section.class_name }} - {{ section.get_name_display }}</h4>

    {% if request.GET.date %}
    <div class="alert alert-info" role="alert">
      Showing Results for {{ request.GET.date }}
    </div>
    {% else %}
    <h5> <span class="text-success">Today</span> ({{ date }}) </h5>
    {% endif %}

    <form action="" method="GET" class="row g-2 mb-2">
      <div class="col-auto fw-bold text-danger">
        <label for="date">FILTER: </label>
      </div>

      <div class="col-auto">
        <input type="date" id="date" name="date" class="form-control form-control-sm" value="{{ date }}">
      </div>
      <div class="col-auto">
        <input type="submit" value="Apply Filter" class="btn btn-sm btn-success">
      </div>


      {% if request.GET.date %}
      <div class="col-auto">
        <a href="?" class="btn btn-sm btn-warning ">Reset Filter</a>
      </div>
      {% endif %}

    </form>
  </div>

  <script>
    // Function to get the CSRF token from cookies
    function getCSRFToken() {
      const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
      return csrfCookie ? csrfCookie.split('=')[1] : null;
    }

    function updateAttendance(studentId, status) {
      const csrfToken = getCSRFToken();

      $.ajax({
        url: '{% url "dashboard:section_student_attendance_new" %}',
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
        },
        data: {
          student_id: studentId,
          date: '{{ date }}',
          status: status
        },
        success: function (data) {
          console.log(data);

          // Assuming data is a boolean value (True or False)
          if (data.status == "True") {
            // If the value is True, update the corresponding HTML element for Present
            $(".status" + data.class_roll).html('<i class="fa-solid fa-circle-check text-success"></i> Present');
          } else {
            // If the value is False, update the corresponding HTML element for Absent
            $(".status" + data.class_roll).html('<i class="fa-solid fa-circle-xmark text-danger"></i> Absent');
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }
  </script>

  <div class="row">
    <table class="table table-striped text-center ">
      <thead>
        <tr>
          <th>Class Roll</th>
          <th>Student Name</th>
          <th>Attendance Status</th>
        </tr>
      </thead>
      <tbody>
        {% for student in students %}
        <tr>
          <td>{{ student.class_roll }}</td>
          <td>{{ student.student.name_en }}</td>
          <td class="status{{ student.class_roll }}">

            {% with attendance=attendances|get_by_student:student %}
            {% if attendance %}
            {% if attendance.status %}
            <i class="fa-solid fa-circle-check text-success"></i> Present
            {% else %}
            <i class="fa-solid fa-circle-xmark text-danger"></i> Absent
            {% endif %}

            {% else %}

            <button class="btn btn-sm btn-warning " onclick="updateAttendance('{{ student.id }}', 'True')">
              <i class="fa-solid fa-circle-check text-success"></i>
            </button>

            <button class="btn btn-sm btn-info " onclick="updateAttendance('{{ student.id }}', 'False')">
              <i class="fa-solid fa-circle-xmark text-danger"></i>
              </a>

              {% endif %}
              {% endwith %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}